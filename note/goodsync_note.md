# GoodSync 監控整合手冊

## 一、GoodSync 數據位置

### 1.1 主要數據目錄
```
C:\Users\[用戶名]\AppData\Local\GoodSync\
├── jobs-groups-options.tic     # 同步作業配置
├── GsAcct.tic                  # 授權資訊
├── LocalAcct.tic               # 本地帳號
├── GoodSync-*.log              # 運行日誌
├── _mirrors_\                  # 同步狀態目錄
│   ├── file-[磁碟]-[路徑]\     # 本地同步
│   ├── smb-[IP]-[共享名]\      # NAS同步
│   ├── gdrive-[ID]-[路徑]\     # Google Drive同步
│   └── ftp-[主機]-[路徑]\      # FTP同步
└── GoogleDriveCache\           # Google Drive緩存
```

### 1.2 次要數據目錄（服務器配置）
```
C:\ProgramData\GoodSync\server\
├── settings.tix                # 服務器設定
├── users.tix                   # 用戶帳號
├── gserver-*.log              # 服務器日誌
└── gs-server-*.crt/key        # SSL證書
```
**注意**：服務器目錄對同步監控無用，只是 GoodSync Server 的配置。

## 二、檔案類型說明

### 2.1 核心檔案（必需）

| 檔案 | 用途 | 更新時機 | 重要性 |
|------|------|---------|--------|
| **jobs-groups-options.tic** | 同步作業配置（路徑、選項） | 修改配置時 | ⭐⭐⭐ |
| **_mirrors_ 目錄** | 實際同步狀態和時間 | 每次同步時 | ⭐⭐⭐ |
| **GsAcct.tic** | 授權和帳號資訊 | 帳號變更時 | ⭐⭐ |

### 2.2 輔助檔案（可選）

| 檔案 | 用途 | 更新時機 | 重要性 |
|------|------|---------|--------|
| **GoodSync-*.log** | 詳細活動記錄 | 持續更新 | ⭐⭐ |
| **LocalAcct.tic** | 本地帳號設定 | 很少更新 | ⭐ |

### 2.3 無關檔案

- `server-accounts-*.tic` - 服務器帳號備份
- `jobs-groups-options-[日期].tic` - 配置備份
- `GoogleDriveCache/` - 緩存目錄

## 三、TIC 檔案詳細解析

### 3.1 TIC 檔案整體結構

TIC 檔案是特殊編碼的文本格式，包含三個主要部分：

```
[全局設定][作業列表][作業群組][已刪除作業]
```

### 3.2 作業記錄結構詳解

每個同步作業的完整結構：

```
[n:名稱長度:作業名稱|參數集合]
```

#### 主要參數解析

| 參數 | 格式 | 說明 | 範例 |
|------|------|------|------|
| **n:** | `n:長度:名稱` | 作業名稱 | `n:16:GD-CompanyGallery` |
| **6=** | `6=時間戳記` | 創建或修改時間 | `6=1712334001` |
| **8[]** | `8[k:類型|U:長度:路徑]` | 左側（源）路徑 | `8[k:8:file://@\|U:18:/K:/Company-Gallery]` |
| **9[]** | `9[k:類型|U:長度:路徑]` | 右側（目標）路徑 | `9[k:50:gdrive://ID@api\|U:43:/folder/path]` |
| **F[]** | `F[F=0\|H=0\|S=0\|T=1]` | 過濾器設定 | 詳見過濾器部分 |
| **d=** | `d=2` | 同步方向 | 2=雙向, 1=單向 |
| **e=** | `e=0` | 錯誤處理 | 0=停止, 1=繼續 |
| **f=** | `f=1` | 文件衝突處理 | 1=較新覆蓋 |

#### 路徑類型識別（k: 參數）

| k: 值 | 類型 | 說明 | 路徑格式範例 |
|-------|------|------|--------------|
| `file://@` | 本地檔案 | 本機磁碟 | `/K:/Folder-Name` |
| `smb://` | 網路共享 | NAS/共享資料夾 | `192.168.1.100/ShareName` |
| `gdrive://` | Google Drive | 雲端硬碟 | `[AccountID]@www.googleapis.com` |
| `ftp://` | FTP | 遠端伺服器 | `user@host` |

#### 路徑格式轉換規則

TIC 檔案中的路徑使用正斜線，需要轉換：

1. **本地路徑**：
   - TIC: `/K:/Company-Gallery`
   - 轉換後: `K:\Company-Gallery`

2. **深層路徑**：
   - TIC: `/K:/Parent-Folder/SubFolder/File`
   - 轉換後: `K:\Parent-Folder\SubFolder\File`

3. **特殊符號**：
   - `/=Art:` → 磁碟無法訪問標記
   - 空格保持原樣

### 3.3 同步選項參數詳解

#### 基本選項

| 參數 | 值域 | 說明 | 預設值 |
|------|------|------|--------|
| **d=** | 1,2 | 1=單向同步, 2=雙向同步 | 2 |
| **e=** | 0,1 | 0=遇錯停止, 1=繼續 | 0 |
| **f=** | 0,1,2 | 0=跳過, 1=覆蓋, 2=重命名 | 1 |
| **u=** | 0,1 | 0=停用, 1=啟用自動同步 | 1 |
| **v=** | 0,1 | 0=不驗證, 1=驗證複製 | 0 |
| **j=** | 0,1 | 0=不記錄, 1=記錄日誌 | 1 |

#### 進階選項

| 參數 | 說明 | 典型值 |
|------|------|--------|
| **==** | 同步速度限制(%) | 100=全速 |
| **q=** | 靜默模式 | 0=正常 |
| **w=** | 等待時間 | 0=不等待 |
| **z=** | 壓縮傳輸 | 0=不壓縮 |
| **o=** | 保留原始時間 | 1=保留 |
| **p=** | 保留權限 | 1=保留 |
| **L=** | 跟隨符號連結 | 1=跟隨 |

#### 過濾器結構（F[]）

```
F[F=0|H=0|S=0|T=1|m=0|i[L<規則>]x[L<排除規則>]]
```

| 參數 | 說明 | 值 |
|------|------|-----|
| F= | 過濾器啟用 | 0=停用, 1=啟用 |
| H= | 隱藏檔案 | 0=包含, 1=排除 |
| S= | 系統檔案 | 0=包含, 1=排除 |
| T= | 暫存檔案 | 0=包含, 1=排除 |
| i[] | 包含規則 | 檔案模式列表 |
| x[] | 排除規則 | 檔案模式列表 |

常見排除規則範例：
```
x[L<:13:name *._gstmp|:9:Thumbs.db|:9:.DS_Store|>]
```

### 3.4 群組結構

作業可以組織成群組：

```
g(
[n:群組名|t=4|j(:作業1:作業2:作業3)s=時間戳記|]
)
```

| 參數 | 說明 |
|------|------|
| n: | 群組名稱 |
| t= | 群組類型 |
| j() | 包含的作業列表 |
| s= | 最後修改時間 |

### 3.5 特殊字符處理

TIC 檔案中的特殊編碼：

| 原始字符 | TIC 編碼 | 說明 |
|---------|---------|------|
| `:` | 長度前綴 | 用於字串長度標記 |
| `\|` | 管道符 | 參數分隔符 |
| `/` | 正斜線 | 路徑分隔符（需轉換） |
| `@` | At符號 | 帳號分隔符 |
| `=` | 等號 | 參數賦值或特殊標記 |

### 3.6 解析範例

原始 TIC 記錄：
```
[n:13:GD-MainFolder|6=1709984044|2=0|3=0|4=0|
8[k:8:file://@|U:15:/K:/Main-Folder|m:0:|T=0|]
9[k:50:gdrive://[AccountID]@www.googleapis.com-n1|U:36:/Work/BackUp/Main|m:0:|T=0|]
F[F=0|H=0|S=0|T=1|m=0|i[L<>]x[L<>]]
d=2|e=0|f=1|u=1|v=0|j=1|==100|...]
```

解析結果：
```json
{
  "name": "GD-MainFolder",
  "timestamp": 1709984044,
  "left_side": {
    "type": "file",
    "path": "K:\\Main-Folder"
  },
  "right_side": {
    "type": "gdrive",
    "path": "/Work/BackUp/Main",
    "account": "[AccountID]"
  },
  "options": {
    "direction": "two-way",
    "error_handling": "stop",
    "conflict": "overwrite",
    "auto_sync": true
  },
  "filter": {
    "exclude_temp": true,
    "exclude_hidden": false,
    "exclude_system": false
  }
}
```

## 四、_mirrors_ 目錄解析

### 4.1 命名規則詳解

**基本格式**：`[協議]-[位置標識]-[路徑]`

#### 本地檔案（file-）
```
file-[磁碟]-[路徑用連字符分隔]
例：file-K-Company-Gallery
解析：K:\Company-Gallery
```

#### 網路共享（smb-）
```
smb-[IP地址]-[共享名稱]
例：smb-192.168.1.100-SharedFolder
解析：\\192.168.1.100\SharedFolder
```

#### Google Drive（gdrive-）
```
gdrive-[帳號ID]-[路徑]
例：gdrive-[AccountID]-Work-Backup
解析：Google Drive 帳號的 /Work/Backup
```

#### FTP（ftp-）
```
ftp-[用戶]@[主機]-[路徑]
例：ftp-[user]@[hostname]-public
解析：ftp://[user]@[hostname]/public
```

### 4.2 特殊案例處理

| 特殊情況 | _mirrors_ 名稱 | 實際含義 |
|----------|---------------|----------|
| 磁碟無法訪問 | `file-=` | 磁碟離線或無法訪問 |
| 空格路徑 | `file-K-Project Name` | K:\Project Name（保留空格） |
| 多層路徑 | `file-K-Parent-Child-Sub` | 需要判斷連字符歸屬 |
| 中文路徑 | `file-K-專案-子目錄` | 保留原始中文 |

### 4.3 歧義處理策略

**問題**：無法區分路徑分隔符和目錄名中的連字符

**解決方案優先級**：
1. 從 TIC 檔案獲取正確路徑作為參考
2. 維護已知目錄模式列表
3. 使用檔案系統驗證（檢查路徑是否存在）
4. 根據上下文推斷（相同前綴的其他作業）

## 五、LOG 檔案解析

### 5.1 LOG 記錄格式

```
YYMMDD-HHMMSS #線程ID [作業名] 訊息內容
```

範例：
```
250828-005656 #259 [GD-CompanyData] 分析已由 On File Change, After Delay 啟動
```

### 5.2 重要事件類型

| 事件類型 | 關鍵字 | 資訊價值 |
|---------|--------|----------|
| **同步開始** | `分析已由` | 觸發原因、時間 |
| **文件變更** | `Change detected` | 變更類型、路徑 |
| **同步進度** | `複製時間` | 速度、數量 |
| **同步完成** | `同步完成` | 成功/失敗統計 |
| **錯誤警告** | `Error`, `Warning` | 問題診斷 |
| **路徑寫入** | `write Job Log to` | _mirrors_ 路徑對應 |
| **連線狀態** | `Connected to` | 連線成功確認 |
| **Token更新** | `AccessToken` | 雲端服務認證 |

### 5.3 狀態追蹤

從 LOG 可以建立完整的同步時間線：

1. **觸發階段**
   - `Detected File Changes` - 檢測到變更
   - `Waiting out Delay` - 等待延遲

2. **分析階段**
   - `分析已由...啟動` - 開始分析
   - `Change Analyzed` - 分析特定變更
   - `分析完成` - 完成分析

3. **同步階段**
   - `同步作業已由...啟動` - 開始同步
   - `Start only X threads` - 線程分配
   - `同步完成` - 完成同步

4. **清理階段**
   - `Cleanup recycled files` - 清理回收站
   - `Unlocking folder` - 解鎖資料夾

## 六、數據整合策略

### 6.1 三層數據模型

```
┌─────────────┐
│  配置層     │ ← TIC 檔案（靜態配置）
├─────────────┤
│  狀態層     │ ← _mirrors_ 目錄（同步狀態）
├─────────────┤
│  活動層     │ ← LOG 檔案（實時活動）
└─────────────┘
```

### 6.2 數據優先級

| 資訊類型 | 優先來源 | 備用來源 | 原因 |
|---------|---------|---------|------|
| 作業路徑 | TIC | _mirrors_ | TIC 格式明確無歧義 |
| 同步時間 | _mirrors_ | LOG | _mirrors_ 是實際狀態 |
| 錯誤資訊 | LOG | - | 只有 LOG 有詳細錯誤 |
| 作業配置 | TIC | - | 只有 TIC 有完整配置 |

### 6.3 資料關聯

建立三者關聯的關鍵：

1. **作業名稱**：三處都有，是主要關聯鍵
2. **_mirrors_ 路徑**：LOG 中有寫入記錄
3. **時間戳記**：可以關聯事件順序

## 七、最佳實踐建議

### 7.1 目錄命名規範

**強烈建議避免**：
- 連字符 `-` → 使用底線 `_`
- 空格 ` ` → 使用底線 `_`
- 特殊符號 `@#$%` → 避免使用

**推薦命名模式**：
```
好：K:\Company_Data\Project_2025
差：K:\Company-Data\Project 2025
```

### 7.2 同步作業命名

使用有意義的前綴：
- `GD_` - Google Drive 同步
- `NAS_` - 網路儲存同步
- `FTP_` - FTP 同步
- `Local_` - 本地備份

### 7.3 監控應用開發建議

#### 初始化流程
1. 讀取 TIC 建立作業清單
2. 掃描 _mirrors_ 匹配作業
3. 建立路徑映射表
4. 載入最新 LOG 檔案

#### 實時監控
1. 使用檔案監視器監控 LOG 變化
2. 定期（5分鐘）檢查 _mirrors_ 修改時間
3. 定期（1小時）重新載入 TIC 配置

#### 錯誤處理
- TIC 鎖定：實施重試機制（3次，間隔1秒）
- 路徑歧義：維護已知模式清單
- LOG 過大：只讀取最後 N 行或增量

## 八、常見問題排查

### 8.1 數據不一致

| 症狀 | 可能原因 | 解決方法 |
|------|---------|---------|
| TIC 有但 _mirrors_ 沒有 | 新建未執行的作業 | 等待首次同步 |
| _mirrors_ 有但 TIC 沒有 | 已刪除的作業 | 清理 _mirrors_ |
| 時間不匹配 | TIC 是配置時間 | 使用 _mirrors_ 時間 |

### 8.2 解析錯誤

| 錯誤類型 | 症狀 | 解決方法 |
|---------|------|---------|
| 編碼錯誤 | 中文亂碼 | 使用 UTF-8，忽略錯誤 |
| 路徑錯誤 | 找不到檔案 | 檢查連字符解析 |
| 格式錯誤 | 解析失敗 | 檢查 TIC 檔案完整性 |

### 8.3 性能優化

1. **緩存策略**
   - 緩存 TIC 解析結果（1小時有效）
   - 緩存路徑映射表
   - 只處理 LOG 增量

2. **資源控制**
   - LOG 檔案只保留 7-10 天
   - 定期清理備份 TIC
   - 限制同時監控的作業數

## 九、版本相容性

### 9.1 GoodSync 版本差異

| 版本 | TIC 格式 | _mirrors_ | LOG 格式 |
|------|---------|-----------|----------|
| 11.x | 基本格式 | 標準 | 標準 |
| 12.x | 增加參數 | 相同 | 增加詳細度 |

### 9.2 跨平台注意事項

| 平台 | 路徑格式 | 編碼 | 特殊處理 |
|------|---------|------|---------|
| Windows | 反斜線 `\` | UTF-8/ANSI | 磁碟機代號 |
| macOS | 正斜線 `/` | UTF-8 | 無磁碟機 |
| Linux | 正斜線 `/` | UTF-8 | 權限問題 |

---

*本手冊基於 GoodSync 12.9.7.7 版本編寫*
*最後更新：2025-08-28*
*注意：所有範例已移除或替換個人識別資訊*